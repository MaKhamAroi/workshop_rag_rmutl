# app.py
import os
import streamlit as st
from groq import Groq
from qdrant_client import QdrantClient
from qdrant_client.models import PointStruct, VectorParams, Distance
from sentence_transformers import SentenceTransformer
from dotenv import load_dotenv

# 1. โหลด environment variables จากไฟล์ .env
load_dotenv()

# 2. เริ่มต้น Qdrant (แบบ In-Memory)
qdrant_client = QdrantClient(":memory:")  # ใช้ In-Memory

# สร้าง Collection สำหรับเก็บเวกเตอร์
qdrant_client.recreate_collection(
    collection_name="documents",
    vectors_config=VectorParams(size=384, distance=Distance.COSINE)  # ใช้ 384-D embedding
)

# 3. ข้อมูลเอกสารที่กำหนดเอง
documents = [
    "research_objective: เพื่อศึกษาอัตลักษณ์ทางประวัติศาสตร์และวัฒนธรรมของนครน่าน",
    "research_question: จากพัฒนาการทางสังคมผ่านการก่อเกิดชุมชนตลอดจนพลวัตรทางสังคมส่งผลให้เกิดอัตลักษณ์ทางประวัติศาสตร์และวัฒนธรรมของนครน่านอย่างไร",
    "research_methodology: การศึกษาเรื่อง “นครน่านเมืองเก่าที่มีชีวิต : การอัตลักษณ์ทางประวัติศาสตร์และวัฒนธรรม” ใช้วิธีวิจัยเชิงคุณภาพทางมานุษยวิทยา เน้นการทำงานสนาม มีประชากรการวิจัยและวิธีการเก็บข้อมูลดังนี้",
    "research_population: ประชากรการวิจัยมี 2 กลุ่ม คือ กลุ่มคนน่านและกลุ่ม “คนอื่น” ที่ไม่ใช่คนน่านถาวร",
    "data_collection_method: ผู้วิจัยจะเก็บข้อมูลที่เน้นปฏิบัติการวิจัยสนาม ณ พื้นที่ในเขตเมืองเก่าน่าน, ปริมณฑลรอบนอกที่เกี่ยวข้องกับเมืองเก่าน่าน, เอกสาร, สื่อโสตทัศนสาร และพื้นที่พิเศษใน Cyber Space",
    "research_tools: เครื่องมือที่ใช้ในการวิจัย คือ แบบสัมภาษณ์, แบบบันทึกการทำงานสนาม และเครื่องมือบันทึกข้อมูลโสตทัศนสาร",
    "research_scope: ขอบเขตการวิจัย 1. ขอบเขตพื้นที่การวิจัย: พื้นที่ปฏิบัติงานภาคสนามในเขตเมืองเก่าน่านทั้ง 2 ส่วนและปริมณฑลของนครน่าน; พื้นที่ที่เกี่ยวข้องกับการวิจัย คือ พื้นที่ที่อยู่นอกเหนือจากพื้นที่เมืองน่าน. 2. ขอบเขตด้านระยะเวลา: ใช้เวลาในการศึกษาวิจัย 1 ปี (มีนาคม พ.ศ.2555 – มีนาคม พ.ศ.2556)",
    "data_analysis_method: การวิเคราะห์ข้อมูลใช้การวิเคราะห์เชิงคุณภาพเพื่อยืนยันความน่าเชื่อถือและความเที่ยงตรง โดยใช้การตรวจสอบข้อมูลแบบสามเส้า (Triangulation) โดยตรวจสอบแหล่งที่มา 3 แหล่ง ได้แก่ เวลา, สถานที่ และบุคคล",
    "content_analysis: การวิเคราะห์ข้อมูลเชิงคุณภาพแบ่งออกเป็น 2 ส่วน คือ 1. การวิเคราะห์เนื้อหา (Content Analysis) กับข้อมูลจากเอกสาร และ 2. การวิเคราะห์ข้อมูลแบบสร้างข้อสรุป (Descriptive) จากการสังเกต, สัมภาษณ์ และจดบันทึก",
    "research_conclusion: สรุปผลการวิจัย นครน่าน : อัตลักษณ์ทางประวัติศาสตร์",
    "historical_identity: ข้อมูลทางประวัติศาสตร์มีการเปลี่ยนแปลงอยู่ตลอดเวลา หากมีการค้นพบหลักฐานเพิ่มเติม ข้อมูลที่มีอยู่จะล้าหลังทันที ดังนั้น การศึกษาองค์ความรู้ทางประวัติศาสตร์จึงไม่มีคำว่าสิ้นสุด ขึ้นอยู่กับบริบทของแต่ละพื้นที่",
    "interest_in_history: ผู้วิจัยมีความสนใจในการก่อเกิดและพัฒนาการทางประวัติศาสตร์ของ “นครน่าน” ซึ่งเป็นนครรัฐเล็กในอดีตบนดินแดนหัวเมืองล้านนาด้านทิศตะวันออก ที่เป็นที่ราบลุ่มน้ำและถูกล้อมรอบด้วยเทือกเขาสูง",
    "geographical_factor: ปัจจัยทางภูมิศาสตร์เป็นตัวกำหนดและก่อเกิดความพยายามเอาชนะธรรมชาติเพื่อการตั้งถิ่นฐานอย่างมั่นคง ผ่านวิวัฒนาการตัวเมืองมาหลายยุคหลายสมัย ส่งผลให้เกิดความรู้สึกทางจิตใจ, จิตวิญญาณ และจินตนาการ (mental space) ในการสร้างและประสานความหมายของ “พื้นที่-ความศรัทธา” และ “การดำรงอยู่” ในสังคมและวัฒนธรรม",
    "historical_identity_summary: สรุปอัตลักษณ์ทางประวัติศาสตร์ได้ว่า นครน่านเป็นเมืองที่เกิดขึ้นจากปัจจัยทางภูมิศาสตร์ที่เอื้อต่อการตั้งถิ่นฐาน และในปัจจุบันเป็นมรดกทางสังคมที่กลายเป็นทุนทางวัฒนธรรมในมิติของเศรษฐกิจสร้างสรรค์ผ่านวาทกรรม “เมืองเก่าที่มีชีวิต”",
    "prehistory_identity: นครน่านสมัยก่อนประวัติศาสตร์ แสดงให้เห็นว่าด้วยสภาพภูมิศาสตร์ของพื้นที่ราบขนานกับแม่น้ำและลำน้ำที่สาขาไหลผ่าน เป็นปัจจัยที่เอื้อต่อการตั้งถิ่นฐานของมนุษย์ พบหลักฐานทางโบราณคดีที่สันนิษฐานว่ามีมาตั้งแต่ 35,000-25,000 ปี",
    "archaeological_evidence: พบหลักฐานทางโบราณคดีเกี่ยวกับการตั้งถิ่นฐานของมนุษย์ในจังหวัดน่าน และเครื่องมือยุคก่อนประวัติศาสตร์ที่ทำจากหินกรวดและสาริด",
    "settlement_pattern: มนุษย์กลุ่มแรกอาศัยอยู่ตามลาดไหล่เขาและที่ราบใกล้ลำน้ำ โดยพบเครื่องมือที่มีการกะเทาะทั้งหยาบและประณีต",
    "archaeological_sites: มีการค้นพบหลักฐานทางโบราณคดีชิ้นสำคัญ เช่น กลองมโหระทึก 2 ใบ และเครื่องใช้สาริดในพื้นที่ จ.น่าน",
    "archaeological_impact: หลักฐานทางโบราณคดีในนครน่านบ่งบอกถึงความเจริญทางการดำรงชีวิตในยุคก่อนประวัติศาสตร์",
    
    """historical_period_stage1: น่าน ระยะที่ 1 ยุคการสร้างเมืองวรนคร-เวียงน่าน (ปลายพุทธศตวรรษที่ 18-พ.ศ.1992)
    ยุคนี้ถือเป็นปฐมบทของการก่อเกิดเมือง เพราะปรากฏตานานในประชุมพงษาวดาร ภาค 10 เรื่อง ราชวงษปกรณ์ พงษาวดารเมืองน่าน ฉบับพระเจ้าสุริยพงษ์ผริตเดช ที่ให้แต่งไว้สำหรับบ้านเมือง ซึ่งได้อธิบายความเป็นมาและสามารถวิเคราะห์ตานานเชิงประวัติศาสตร์เหนือธรรมชาตินี้ได้ ส่งผลต่อจักรวาลวิทยาของคนน่าน ที่มีความเชื่อในตานานการถือกำเนิดว่า พวกเขาต่างออกมาจากไข่ 2 ฟอง ส่งผลให้เกิดการรับรู้เกี่ยวกับความชอบธรรมของตนเองว่าไม่ได้อพยพมาจากดินแดนอื่น คนน่านได้ถูกเน้นย้ำความเป็นตัวตนให้ปรากฏในประเพณีและวิถีชีวิตต่าง ๆ และจักรวาลวิทยาดังกล่าวยังทำให้รับทราบร่วมกันว่ารากฐานบ้านเมืองน่านมีความเกี่ยวข้องกับเมืองหลวงพระบาง ตามตานานที่เล่าเรื่องราวเชิงประวัติศาสตร์เหนือธรรมชาติ โดยมีหลักฐานเช่นศาลเจ้าหลวงภูคา บนยอดอยภูคา และร่องรอยชุมชนโบราณในเขต อ.ปัว ปัจจุบัน นอกจากนี้ พบว่าการเมืองในยุคนี้มีเจ้าผู้ครองนคร 2 องค์ คือ เจ้าขุนฟองกับพญากรานเมือง เหตุการณ์สำคัญทางประวัติศาสตร์ที่ยืนยันการประดิษฐานพระพุทธศาสนาอย่างมั่นคงในดินแดนแห่งนี้ ได้แก่ การสร้างพระธาตุแช่แห้งใน พ.ศ.1901 ซึ่งเชื่อมโยงกับความสัมพันธ์ในบริบทรัฐชาติและการติดต่อกับอาณาจักรสุโขทัย รวมทั้งสมัยเจ้าพญากรานเมือง (พ.ศ.1896-พ.ศ.1906) มีการย้ายเมือง ครั้งที่ 1 จากวรนคร (อ.ปัว) มาสร้าง ณ เวียงภูเพียงแช่แห้ง (ปัจจุบัน อ.ภูเพียง) ใน พ.ศ.1902 หลังจากสร้างพระมหาธาตุแช่แห้งใน พ.ศ.1901 เพื่อความสะดวกในการประกอบศาสนกิจและเสด็จมานมัสการ จากนั้นมีการย้ายเมือง ครั้งที่ 2 สมัยเจ้าพญาผากอง (พ.ศ.1906-พ.ศ.1931) ย้ายจากเวียงภูเพียงแช่แห้งมายังเวียงใต้ (ฝั่งตะวันตกของแม่น้ำน่าน) ใน พ.ศ.1911 เนื่องจากน้ำไม่เพียงพอเพราะเวียงภูเพียงเป็นที่ดอน""",

    """historical_period_stage2: นครน่านระยะที่ 2  ยุคขึ้นกับอาณาจักรล้านนา (พ.ศ.1993-พ.ศ.2101)
    นับตั้งแต่ พ.ศ.1993 พญาติโลกราช กษัตริย์แห่งเชียงใหม่ยกทัพมาตีเพื่อต้องการครอบครองบ่อเกลือบ่อมาง แหล่งผลิตเกลือสินเธาว์ที่หาได้ยากในดินแดนล้านนาสมัยนั้น (ปัจจุบันอยู่ในเขต อ.บ่อเกลือ)
    โดยพญาติโลกราชได้สร้างพระเจ้าทองทิพย์ด้วยสาริด นับเป็นพระพุทธรูปที่ใหญ่ที่สุดในล้านนาไว้ที่วัดสวนตาลเพื่อยืนยันว่าอำนาจล้านนาได้แผ่ขยายมาถึงนครน่าน
    ยุคนี้มีเจ้าผู้ครองนครองค์แรก คือ เจ้าผาแสง (พ.ศ.1993-พ.ศ.2004 รวม 12 ปี) เมื่อท่านถึงแก่พิราลัยแล้ว
    ใน พ.ศ.2004 นับเป็นเจ้าผู้ครองนครในราชวงศ์ภูคาองค์สุดท้าย นับแต่ พญาภูคา เลี้ยงดูบุตรบุญธรรม คือ ขุนฟอง แล้วให้ไปสร้างเมืองปัว (หรือวรนคร)
    ทางอาณาจักรล้านนาก็ส่งเจ้ามาปกครองต่ออีก 18 องค์ ซึ่งส่งเจ้าหมื่นสร้อยเชียงของ (พ.ศ.2005-พ.ศ.2009) มาปกครองใน พ.ศ.2005 เป็นองค์แรก
    จนถึงเจ้าพญาพลเทพฤาชัย ซึ่งปรากฏในศิลาจารึกหลักที่ 72 เรียกชื่อตรงกับพงศาวดารเมืองน่าน ระบุว่าครองนครน่านระหว่าง พ.ศ.2070-พ.ศ.2101 รวม 32 ปี
    ซึ่งท่านได้สร้างวัดหลวงกลางเวียง (วัดช้างค้าหรือวรวิหาร) เมื่อ พ.ศ.2079 และจารึกระบุว่าปฏิสังขรณ์วัดนี้ เมื่อ พ.ศ.2091 จนถึง พ.ศ.2101
    เจ้าฟ้าหงสามังตรา (บุเรงนอง) ยึดนครเชียงใหม่ได้ เจ้าพญาพลเทพฤาชัยไม่ยอมสวามิภักดิ์ จึงเสด็จลี้ภัยไปประทับที่อาณาจักรล้านช้าง (หลวงพระบาง-ปัจจุบัน)
    ถือเป็นการสิ้นสุดนครน่านยุคขึ้นกับอาณาจักรล้านนา""",
    """historical_period_stage3: นครน่าน ระยะที่ 3 ยุคตกเป็นเมืองขึ้นของพม่า (พ.ศ.2103-พ.ศ.2328)
    หลังจากเจ้าฟ้าหงสามังตรา (บุเรงนอง) ยึดนครเชียงใหม่ได้ และนครน่านต้องขึ้นตรงต่อการปกครองของพม่าที่นครเชียงใหม่ด้วย และเจ้าพญาพลเทพฤาชัย เจ้าผู้ครองนครน่านในขณะนั้น ได้เสด็จลี้ภัยไปประทับที่อาณาจักรล้านช้างแล้ว (หลวงพระบาง-ปัจจุบัน)
    พระเจ้าหงสาวดีบุเรงนองก็โปรดฯ ให้พญาหน่อกาสถียรชัยสงครามมาครองนครน่านต่อ (พ.ศ.2103-พ.ศ.2134) ระหว่างนั้น พ.ศ.2123 มีการบูรณะพระธาตุแช่แห้ง ศูนย์กลางการประดิษฐานพระพุทธศาสนาในนครน่าน ช่วงที่ขึ้นต่อการปกครองของพม่ากว่า 200 ปี
    เจ้าผู้ครองนครน่านหลายองค์ได้พยายามแข็งเมืองต่อพม่าแต่ไม่สำเร็จ เช่น เจ้าเจต บุตรพรหมมินทร์ เจ้าผู้ครองนครน่านองค์ต่อมา ได้แข็งเมืองต่อเจ้าฟ้าสาระวดี (หรือมังนธาช่อ โอรสบุเรงนอง เจ้าผู้ครองนครเชียงใหม่) ใน พ.ศ.2104 แต่ไม่สำเร็จ จึงเสด็จลี้ภัยไปประทับที่อาณาจักรล้านช้าง (หลวงพระบาง-ปัจจุบัน) แล้วกลับมาครองนครน่านอีกครั้ง (พ.ศ.2143-พ.ศ.2146) แล้วถูกมังนรธาช่อ เจ้าผู้ครองนครเชียงใหม่ ในขณะนั้น ยกพลมาตีนครน่านแล้วจับองค์ท่านไปประหารชีวิตที่นครเชียงใหม่
    นอกจากนี้ ใน พ.ศ.2246 พระเมืองราชาเจ้าผู้ครองนครน่าน (พ.ศ.2232-พ.ศ.2246) ได้แข็งเมืองต่อพม่า พระเจ้ากรุงอังวะจึงส่งกองทัพจากเชียงใหม่มาปราบจนนครน่านเสียหายอย่างหนัก เป็นเมืองร้างไปถึง 5 ปี
    ต่อมาพญานาขวา (น้อยอินทร์) ผู้รักษานครน่านได้ขอพระเจ้ากรุงอังวะ อัญเชิญพญาหลวงติ๋นมหาวงศ์ เจ้า ผู้ครองนครเชียงใหม่ มาเป็นเจ้าผู้ครองนครน่าน (พ.ศ.2269-พ.ศ.2294) เมื่อ พ.ศ.2269 ซึ่งพญาหลวงติ๋นมหาวงศ์นี้ นับเป็นต้นราชวงศ์หลวงติ๋นมหาวงศ์ (อันเป็นบรรพบุรุษสายสกุล “ณ น่าน” นามสกุลพระราชทานในปัจจุบัน)
    ยุคนี้ตรงกับช่วงที่พระเจ้าตากสินมหาราชแห่งกรุงธนบุรีกอบกู้เอกราชกรุงศรีอยุธยาจากพม่าได้ในปี 2310 จึงทรงยกทัพมาตีเชียงใหม่ ซึ่งเจ้าหัวเมืองล้านนาในขณะนั้นยอมสวามิภักดิ์ด้วย ยกเว้นเจ้าน้อยวิทูร เจ้าผู้ครองนครน่าน (พ.ศ.2317-พ.ศ.2321) ซึ่งในขณะนั้นยังยืนยันที่จะสวามิภักดิ์กับพม่าจึงถูกคุมตัว"""
    
        """drum_tradition: วงกลองแอว-กลองอืด
    วงกลองแอวและกลองอืดเป็นชื่อเรียกกลองชนิดเดียวกัน โดยใช้คำว่า "กลองแอว" สำหรับกลองเดียว และเรียกเป็น "กลองอืด" เมื่อรวมกับเครื่องดนตรีอื่นๆ ในวงกลอง พบว่ามีการเรียกชื่อเหล่านี้เฉพาะในสองจังหวัด ได้แก่ จังหวัดแพร่และจังหวัดน่าน โดยการเรียก "กลองอืด" มาจากเสียงของปลายกลองที่ดังว่า "อืด" หรือ "สืด" (ยุทธพร นาคสุข, 2550, 47-75)
    กลองชนิดนี้นิยมใช้ในการแข่งตีกลองในงานสำคัญ เช่น งานสรงน้ำพระธาตุหรืองานนมัสการพระธาตุสำคัญในเมือง เช่น วัดสวนตาล, วันพระธาตุแช่แห้ง, วัดพระธาตุเขาน้อย รวมถึงงานบุญประเพณีต่างๆ
    เจ้าลัดดา ณ น่าน เล่าถึงการฟ้อนกลองอืดในสมัยที่มีพระเจ้าอยู่หัวรัชกาลที่ 7 ในการรับเสด็จพระเจ้าอยู่หัว โดยเจ้าแม่ของท่านเคยเล่าเกี่ยวกับการฟ้อนกลองอืดที่ใช้ในการแสดงพระเกียรติในงานสำคัญๆ
    ปัจจุบัน วงกลองอืดที่มีชื่อเสียงคือ วงกลองอืดวัดพญาภู ที่ยังคงอนุรักษ์และสืบทอดการแสดงฟ้อนกลองอืดในงานประเพณีต่างๆ ซึ่งยังเป็นการสร้างรื้อฟื้นทางวัฒนธรรมของนครน่าน"""

    "fons: ฟ้อนล่องน่าน",
    """ฟ้อนล่องน่านเป็นนาฏศิลป์เฉพาะของนครน่าน มีการฟ้อนที่ไม่เหมือนการฟ้อนในที่อื่น โดยมีลักษณะการฟ้อนที่ไม่มีการจีบมือ และฟ้อนตามจังหวะทำนองล่องน่าน
    ประวัติของฟ้อนล่องน่านเกิดขึ้นในปี พ.ศ.1902 เมื่อพระยากรานเมืองอพยพย้ายเมืองจากเมืองวรนครมาสร้างเมืองใหม่ที่ภูเพียงแช่แห้ง โดยมีการขบวนแพเรือพร้อมดนตรีเพื่อล่องมาตามแม่น้ำน่าน เสียงดนตรีทำให้ผู้ร่วมขบวนผ่อนคลาย และชาวเมืองผู้ชายลุกขึ้นฟ้อนตามจังหวะดนตรี
    การฟ้อนล่องน่านได้รับการนำมาจัดแสดงในงานประเพณีต่างๆ และในปัจจุบันนิยมแสดงในการจัดงานบุญประเพณี โดยผู้ฟ้อนส่วนใหญ่เป็นผู้หญิง"""

    "fons: ฟ้อนแง้น",
    """ฟ้อนแง้น หรือฟ้อนแอ่น เป็นนาฏศิลป์ที่เฉพาะของชาวน่าน ใช้แสดงร่วมกับวงสะล้อ ซอ ซึง โดยเป็นการฟ้อนที่ไม่มีการจีบนิ้วแต่ใช้การกรีดนิ้วและหมุนข้อมือ
    การฟ้อนแง้นมีลักษณะการแอ่นตัวไปข้างหลังและสามารถทำให้ศีรษะจรดพื้นได้ แต่ยังคงรักษาสมดุลด้วยการใช้ฝ่ามือดันพื้นเพื่อไม่ให้ล้ม ฟ้อนแง้นมักใช้ในงานบุญประเพณีต่างๆ เช่น งานบวช งานขึ้นบ้านใหม่ หรือการจัดงานกฐิน
    ผู้ชมมักให้รางวัลแก่นักแสดงด้วยการวางธนบัตรเพื่อเป็นการขอบคุณหรือบูชาครู"""

    "boat_race: ประเพณีแข่งเรือ",
    """ประเพณีแข่งเรือของนครน่านเป็นประเพณีที่ตกทอดมาจากอดีต โดยในช่วงแรกเริ่มใช้เรือขี้ระย้าในการแข่งเพื่อความสามัคคีและเป็นการละเล่น
    ในช่วงหลัง การแข่งเรือได้พัฒนาจากเรือขี้ระย้าเป็นเรือหงส์เน้นการแข่งขันเพื่อชัยชนะ และในปัจจุบันมีการผสมผสานกับการท่องเที่ยว
    การแข่งเรือถูกนำมาใช้ในงานรับเสด็จสมเด็จเจ้าฟ้าบริพัตรสุขุมพันธ์ฯ เมื่อปี พ.ศ.2460 และกลายเป็นสัญลักษณ์ของนครน่านในการต้อนรับแขกสำคัญ"""

    "cultural_identity: วัฒนธรรมและอัตลักษณ์",
    """วัฒนธรรมและอัตลักษณ์ของนครน่านเกี่ยวข้องกับพระพุทธศาสนาเป็นหลัก โดยการนมัสการพระธาตุต่างๆ เป็นการแสดงถึงความเจริญงอกงามทางจิตใจของสังคม
    ขนบธรรมเนียมในนครน่าน เช่น การกินข้าวด้วยขันโตก, การแต่งกายพื้นเมือง และมารยาทต่างๆ ล้วนสะท้อนถึงความเชื่อและความเคารพในพระพุทธศาสนา
    สิ่งเหล่านี้สร้างภาพลักษณ์ของนครน่านเป็นแหล่งวัฒนธรรมเฉพาะถิ่นที่มีอัตลักษณ์ที่ชัดเจน"""
]


# 4. แปลงข้อความเป็นเวกเตอร์ และเพิ่มลงใน Qdrant
def add_documents_to_qdrant(documents):
    embedding_model = SentenceTransformer("all-MiniLM-L6-v2")  # โหลดโมเดลสำหรับทำ Embedding
    vectors = embedding_model.encode(documents).tolist()  # แปลงข้อความเป็นเวกเตอร์

    # เพิ่มข้อมูลลง Qdrant
    points = [PointStruct(id=i, vector=vectors[i], payload={"text": documents[i]}) for i in range(len(documents))]
    qdrant_client.upsert(collection_name="documents", points=points)

# 5. สร้างฟังก์ชันการค้นหาเอกสาร
def search_documents(query):
    embedding_model = SentenceTransformer("all-MiniLM-L6-v2")
    query_vector = embedding_model.encode([query])[0].tolist()
    search_results = qdrant_client.search(
        collection_name="documents",
        query_vector=query_vector,
        limit=2  # ดึงเอกสารที่เกี่ยวข้อง 2 อันดับแรก
    )
    return [hit.payload["text"] for hit in search_results]

# 6. สร้างฟังก์ชันการสร้างคำตอบด้วย Groq
def generate_answer(query):
    # ค้นหาข้อมูลที่เกี่ยวข้องจาก Qdrant
    retrieved_docs = search_documents(query)

    # รวมข้อมูลเข้าไปใน Prompt
    context = "\n".join(retrieved_docs)
    prompt = [
        {"role": "system", "content": "คุณเป็นผู้ช่วยที่เชี่ยวชาญเกี่ยวกับข้อมูลในเอกสาร จงตอบคำถามอย่างกระชับและถูกต้อง"},
        {"role": "user", "content": f"ข้อมูลอ้างอิง:\n{context}\n\nคำถาม: {query}\n\nคำตอบ:"}
    ]

    # เรียก Groq API
    groq_client = Groq(api_key=os.getenv("GROQ_API_KEY"))
    response = groq_client.chat.completions.create(
        model="llama-3.3-70b-versatile",
        messages=prompt
    )

    return response.choices[0].message.content

# 7. สร้างอินเทอร์เฟซด้วย Streamlit
def main():
    st.title("RAG Chatbot เกี่ยวกับอัตลักษณ์ทางประวัติศาสตร์ของจังหวัดน่าน")
    st.write("สวัสดี! ฉันคือ Chatbot ที่ช่วยตอบคำถามเกี่ยวกับอัตลักษณ์ของจังหวัดน่าน")

    # เพิ่มข้อมูลเอกสารลงใน Qdrant
    add_documents_to_qdrant(documents)
    st.success("ข้อมูลเอกสารพร้อมใช้งานแล้ว!")

    # รับคำถามจากผู้ใช้
    query = st.text_input("คุณ: ", placeholder="พิมพ์คำถามของคุณที่นี่...")

    if st.button("ส่ง"):
        if query:
            # สร้างคำตอบ
            answer = generate_answer(query)
            st.write("Bot:", answer)
        else:
            st.warning("กรุณาพิมพ์คำถามก่อนส่ง")

# 8. เรียกใช้แอปพลิเคชัน
if __name__ == "__main__":
    main()